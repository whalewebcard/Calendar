<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Workspace Planner - Cloud Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=Mitr:wght@300;400;600&display=swap');
                
        :root {
            --bg-main: #F1F5F9;
            --text-main: #1A1C21;
            --card-bg: rgba(255, 255, 255, 0.8);
            --card-border: rgba(255, 255, 255, 1);
            --nav-bg: rgba(255, 255, 255, 0.6);
        }

        .dark-mode {
            --bg-main: #0F172A;
            --text-main: #F1F5F9;
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(255, 255, 255, 0.05);
            --nav-bg: rgba(15, 23, 42, 0.8);
        }

        body { 
            font-family: 'Plus Jakarta Sans', 'Mitr', sans-serif; 
            background-color: var(--bg-main);
            color: var(--text-main);
            transition: all 0.4s ease;
        }

        .glass-card {
            background-color: var(--card-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--card-border);
        }

        .profile-card:hover { transform: translateY(-8px); }

        .nav-glass {
            background-color: var(--nav-bg);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--card-border);
        }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        .color-circle { width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); cursor: pointer; }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col">
        <!-- HOME VIEW (แสดงโปรไฟล์จาก Cloud) -->
        <div id="home-view" class="fixed inset-0 z-[100] bg-[var(--bg-main)] overflow-y-auto py-20 px-8 flex flex-col items-center">
            <div class="max-w-6xl w-full text-center mb-16 animate-fade-in">
                <h1 class="text-6xl font-black tracking-tighter mb-4">Cloud Workspace</h1>
                <p class="text-slate-500 font-bold uppercase tracking-[0.3em] text-xs">แชร์และวางแผนร่วมกับเพื่อนผ่านระบบคลาวด์</p>
                <div id="auth-status" class="mt-4 text-[10px] text-slate-400 font-mono">กำลังเชื่อมต่อ...</div>
            </div>
            
            <div id="profile-selection-grid" class="max-w-6xl w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
                <!-- ข้อมูลจะถูกโหลดจาก Firestore ที่นี่ -->
                <div class="col-span-full text-center p-12 text-slate-400 animate-pulse font-bold">กำลังดึงข้อมูลจาก Cloud...</div>
            </div>

            <button onclick="createNewProfile()" class="flex items-center gap-3 px-8 py-4 bg-white dark:bg-slate-800 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-[32px] text-slate-500 hover:border-indigo-500 hover:text-indigo-500 transition-all font-bold">
                <i data-lucide="cloud-plus"></i> สร้างโปรไฟล์ใหม่บน Cloud
            </button>
        </div>

        <!-- MAIN WORKSPACE VIEW -->
        <div id="workspace-view" class="hidden flex flex-col min-h-screen">
            <nav class="h-16 nav-glass flex items-end px-8 gap-1 z-30 pt-2 sticky top-0">
                <button onclick="backToHome()" class="mb-1 mr-4 p-2.5 text-slate-400 hover:text-slate-900 transition-all">
                    <i data-lucide="arrow-left"></i>
                </button>
                <div id="tabs-container" class="flex items-end gap-1"></div>
            </nav>

            <main class="flex-1 overflow-y-auto">
                <div class="relative h-72 overflow-hidden">
                    <img id="profile-banner" src="" class="w-full h-full object-cover" alt="Banner">
                    <div class="absolute inset-0 bg-gradient-to-b from-black/30 via-transparent to-[var(--bg-main)]"></div>
                    <div class="absolute bottom-10 left-16">
                        <h2 class="text-5xl font-black text-white tracking-tighter" id="workspace-title">Loading...</h2>
                    </div>
                    <div class="absolute top-10 right-16 flex gap-3">
                        <button onclick="toggleDarkMode()" class="p-4 glass-card rounded-full text-slate-400">
                            <i data-lucide="moon"></i>
                        </button>
                        <button onclick="openSettings()" class="p-4 glass-card rounded-full text-slate-400">
                            <i data-lucide="settings"></i>
                        </button>
                    </div>
                </div>

                <div class="px-16 pb-20 -mt-8 grid grid-cols-1 xl:grid-cols-12 gap-8 relative z-10">
                    <!-- ส่วนปฏิทินและบันทึก -->
                    <section class="xl:col-span-7 flex flex-col gap-8">
                        <div class="glass-card rounded-[48px] p-10 shadow-sm">
                            <div id="calendar-body" class="calendar-grid"></div>
                        </div>
                        <div id="journal-container" class="glass-card rounded-[48px] p-10 shadow-sm">
                            <h3 class="text-xl font-black mb-4">Daily Journal</h3>
                            <textarea id="daily-note-area" oninput="saveDailyNote()" class="w-full h-64 bg-transparent border-none focus:outline-none text-lg" placeholder="เขียนบันทึก..."></textarea>
                        </div>
                    </section>
                    
                    <!-- ส่วน Timeline -->
                    <aside class="xl:col-span-5">
                        <div class="bg-slate-900 rounded-[56px] p-10 text-white h-[calc(100vh-160px)] sticky top-20 overflow-y-auto">
                            <h3 class="text-xs font-black uppercase tracking-widest text-indigo-400 mb-6">Today's Schedule</h3>
                            <div id="timeline-list" class="space-y-4"></div>
                        </div>
                    </aside>
                </div>
            </main>
        </div>

        <!-- SETTINGS MODAL -->
        <div id="settings-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-md z-[200] flex items-center justify-center p-6">
            <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-[48px] p-10 shadow-2xl">
                <h3 class="text-3xl font-black mb-8">Edit Workspace</h3>
                <div class="space-y-6">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Workspace Name</label>
                        <input type="text" id="edit-name" class="w-full bg-slate-100 dark:bg-slate-800 rounded-2xl px-6 py-4 font-bold focus:outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Banner Image URL</label>
                        <input type="text" id="edit-banner" class="w-full bg-slate-100 dark:bg-slate-800 rounded-2xl px-6 py-4 text-sm focus:outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Theme Color</label>
                        <input type="color" id="edit-color" class="w-full h-12 rounded-xl cursor-pointer">
                    </div>
                    <div class="flex gap-4 pt-4">
                        <button onclick="updateCloudProfile()" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">บันทึกและอัปเดต Cloud</button>
                        <button onclick="closeSettings()" class="px-8 py-4 bg-slate-100 dark:bg-slate-800 rounded-2xl font-bold">ยกเลิก</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Setup
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'shared-workspace-v1';

        let user = null;
        let profiles = [];
        let activeIdx = 0;
        let isDarkMode = false;

        // Initialize Auth (Rule 3)
        const startApp = async () => {
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (u) => {
                user = u;
                if (user) {
                    document.getElementById('auth-status').innerText = `เชื่อมต่อแล้ว: ${user.uid.substring(0,8)}`;
                    syncProfiles();
                }
            });
        };

        // Sync Data (Rule 1 & 2)
        const syncProfiles = () => {
            const profilesRef = collection(db, 'artifacts', appId, 'public', 'data', 'profiles');
            onSnapshot(profilesRef, (snapshot) => {
                profiles = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderHome();
                if (document.getElementById('workspace-view').classList.contains('hidden') === false) {
                    renderWorkspace();
                }
            }, (err) => console.error("Cloud Sync Error:", err));
        };

        // Cloud Actions
        window.createNewProfile = async () => {
            const id = user ? user.uid : 'temp-' + Date.now();
            const newProfile = {
                name: 'Workspace ของฉัน',
                banner: 'https://images.unsplash.com/photo-1497215728101-856f4ea42174?auto=format&fit=crop&w=1200&q=80',
                color: '#6366f1',
                owner: id,
                updatedAt: Date.now()
            };
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', id), newProfile);
        };

        window.updateCloudProfile = async () => {
            const p = profiles[activeIdx];
            const updated = {
                ...p,
                name: document.getElementById('edit-name').value,
                banner: document.getElementById('edit-banner').value,
                color: document.getElementById('edit-color').value,
                updatedAt: Date.now()
            };
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', p.id), updated);
            closeSettings();
        };

        // UI Rendering
        const renderHome = () => {
            const grid = document.getElementById('profile-selection-grid');
            grid.innerHTML = '';
            if (profiles.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center p-12 text-slate-400">ยังไม่มีข้อมูลบน Cloud</div>`;
                return;
            }
            profiles.forEach((p, idx) => {
                const card = document.createElement('div');
                card.className = "profile-card glass-card rounded-[40px] overflow-hidden cursor-pointer animate-fade-in transition-all";
                card.onclick = () => openWorkspace(idx);
                card.innerHTML = `
                    <div class="h-32 relative"><img src="${p.banner}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/20"></div></div>
                    <div class="p-8">
                        <h3 class="text-2xl font-black">${p.name}</h3>
                        <p class="text-[10px] font-bold text-slate-400 uppercase mt-2">Owner: ${p.id.substring(0,8)}</p>
                    </div>
                `;
                grid.appendChild(card);
            });
            lucide.createIcons();
        };

        window.openWorkspace = (idx) => {
            activeIdx = idx;
            document.getElementById('home-view').classList.add('hidden');
            document.getElementById('workspace-view').classList.remove('hidden');
            renderWorkspace();
        };

        window.backToHome = () => {
            document.getElementById('home-view').classList.remove('hidden');
            document.getElementById('workspace-view').classList.add('hidden');
        };

        const renderWorkspace = () => {
            const p = profiles[activeIdx];
            document.getElementById('workspace-title').innerText = p.name;
            document.getElementById('profile-banner').src = p.banner;
            
            // Render Tabs
            const tabs = document.getElementById('tabs-container');
            tabs.innerHTML = '';
            profiles.forEach((pr, i) => {
                const btn = document.createElement('button');
                btn.className = `px-6 py-3 rounded-t-2xl text-xs font-black transition-all ${activeIdx === i ? 'bg-white dark:bg-slate-900' : 'text-slate-400'}`;
                btn.innerText = pr.name;
                btn.onclick = () => openWorkspace(i);
                tabs.appendChild(btn);
            });

            // Mock Timeline
            const tl = document.getElementById('timeline-list');
            tl.innerHTML = '';
            for(let i=9; i<=18; i++) {
                tl.innerHTML += `<div class="flex items-center gap-4 p-4 rounded-2xl bg-white/5 border border-white/5"><span class="text-[10px] font-bold opacity-40">${i}:00</span><div class="h-2 flex-1 bg-white/10 rounded-full"></div></div>`;
            }
        };

        window.openSettings = () => {
            const p = profiles[activeIdx];
            document.getElementById('edit-name').value = p.name;
            document.getElementById('edit-banner').value = p.banner;
            document.getElementById('edit-color').value = p.color;
            document.getElementById('settings-modal').classList.remove('hidden');
        };

        window.closeSettings = () => document.getElementById('settings-modal').classList.add('hidden');

        window.toggleDarkMode = () => {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
        };

        startApp();
        lucide.createIcons();
    </script>
</body>
</html>
